<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 登入與筆記管理系統</title>
    <!-- 引入 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        // Firebase 配置與模組載入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyBD4L9AglSZECDBgboOolAOIw_31qbNv8c",
            authDomain: "wk-57f11.firebaseapp.com",
            databaseURL: "https://wk-57f11-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "wk-57f11",
            storageBucket: "wk-57f11.firebasestorage.app",
            messagingSenderId: "355172531717",
            appId: "1:355172531717:web:260f9a31b6ec7e9d12a66c",
            measurementId: "G-ET7WHJGS76"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const database = getDatabase(app);

        let currentUser = null;

        // Google 登入
        async function googleSignIn() {
            try {
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                alert("登入成功！");
                updateUIAfterLogin();
                loadNotes(); // 登入成功後載入筆記
            } catch (error) {
                console.error("登入失敗", error);
                alert("登入失敗：" + error.message);
            }
        }

        // Google 登出
        async function googleSignOut() {
            try {
                await signOut(auth);
                currentUser = null;
                alert("登出成功！");
                resetUI();
            } catch (error) {
                console.error("登出失敗", error);
                alert("登出失敗：" + error.message);
            }
        }

        // 更新登入後的 UI
        function updateUIAfterLogin() {
            document.getElementById("auth-buttons").style.display = "none";
            document.getElementById("note-section").style.display = "block";
        }

        // 重設 UI
        function resetUI() {
            document.getElementById("auth-buttons").style.display = "block";
            document.getElementById("note-section").style.display = "none";
        }

        // 新增筆記
        function addNote() {
            if (!currentUser) {
                alert("請先登入！");
                return;
            }

            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;

            if (title && content) {
                const notesRef = ref(database, `notes/${currentUser.uid}`);
                const newNote = push(notesRef);
                set(newNote, {
                    title,
                    content,
                    timestamp: Date.now(),
                });

                // 清空輸入框
                document.getElementById("title").value = '';
                document.getElementById("content").value = '';
            } else {
                alert("請填寫完整資訊！");
            }
        }

        // 顯示筆記
        function loadNotes() {
            if (!currentUser) return;

            const notesRef = ref(database, `notes/${currentUser.uid}`);
            onValue(notesRef, (snapshot) => {
                const noteList = document.getElementById("note-list");
                noteList.innerHTML = ''; // 清空筆記列表

                const notes = snapshot.val();
                if (notes) {
                    for (const id in notes) {
                        const note = notes[id];
                        const noteItem = document.createElement("li");
                        noteItem.className = "list-group-item";
                        noteItem.innerHTML = `
                            <strong>${note.title}：</strong> ${note.content}
                            <div class="float-end">
                                <button class="btn btn-warning btn-sm me-2" onclick="editNote('${id}')">編輯</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteNote('${id}')">刪除</button>
                            </div>
                        `;
                        noteList.appendChild(noteItem);
                    }
                } else {
                    noteList.innerHTML = "<li class='list-group-item'>目前沒有筆記。</li>";
                }
            });
        }

        // 刪除筆記
        function deleteNote(id) {
            if (!currentUser) return;
            const noteRef = ref(database, `notes/${currentUser.uid}/${id}`);
            remove(noteRef);
        }

        // 編輯筆記
        function editNote(id) {
            if (!currentUser) return;
            const noteRef = ref(database, `notes/${currentUser.uid}/${id}`);
            onValue(noteRef, (snapshot) => {
                const note = snapshot.val();
                const newTitle = prompt("編輯標題", note.title);
                const newContent = prompt("編輯內容", note.content);

                if (newTitle && newContent) {
                    update(noteRef, {
                        title: newTitle,
                        content: newContent,
                        timestamp: Date.now(),
                    });
                }
            }, { onlyOnce: true });
        }

        // 頁面載入時初始化
        window.onload = () => {
            resetUI();
        };

        // 暴露函數給全域使用
        window.googleSignIn = googleSignIn;
        window.googleSignOut = googleSignOut;
        window.addNote = addNote;
        window.editNote = editNote;
        window.deleteNote = deleteNote;
    </script>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Google 登入與筆記管理系統</h1>

        <!-- 登入/登出按鈕 -->
        <div id="auth-buttons" class="text-center">
            <button class="btn btn-primary" onclick="googleSignIn()">Google 登入</button>
        </div>

        <!-- 筆記管理區域 -->
        <div id="note-section" style="display: none;">
            <div class="text-end mb-4">
                <button class="btn btn-danger" onclick="googleSignOut()">登出</button>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">新增筆記</h5>
                </div>
                <div class="card-body">
                    <form id="note-form">
                        <div class="mb-3">
                            <label for="title" class="form-label">標題</label>
                            <input type="text" class="form-control" id="title" placeholder="輸入標題">
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">內容</label>
                            <textarea class="form-control" id="content" rows="3" placeholder="輸入內容"></textarea>
                        </div>
                        <button type="button" class="btn btn-success" onclick="addNote()">新增筆記</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">筆記列表</h5>
                </div>
                <ul class="list-group list-group-flush" id="note-list">
                    <!-- 筆記將從 Firebase 加載 -->
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
